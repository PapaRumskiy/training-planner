{% extends 'main/base.html' %}
{% load static %}

{% block title %}–ö–∞–ª–µ–Ω–¥–∞—Ä{% endblock %}

{% block content %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<div class="calendar-wrapper">
    <div id='calendar'></div>
</div>

<div id="modal">
    <div>
        <h2 style="color: #00d1b2; margin-top: 0; letter-spacing: 2px;">–ù–û–í–ò–ô –ó–ê–ü–ò–°</h2>
        <input type="text" id="note-input" placeholder="–ù–∞–∑–≤–∞ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è (–Ω–∞–ø—Ä. –î–µ–Ω—å –Ω—ñ–≥)...">

        <div style="text-align: left; margin: 25px 0; color: #ccc; font-size: 14px;">
            <label style="display:flex; align-items:center; gap:10px; margin-bottom:12px; cursor:pointer;">
                <input type="radio" name="status" value="planned" id="radio-planned" checked> üü° –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ
            </label>
            <label style="display:flex; align-items:center; gap:10px; margin-bottom:12px; cursor:pointer;">
                <input type="radio" name="status" value="done" id="radio-done"> üü¢ –í–∏–∫–æ–Ω–∞–Ω–æ
            </label>
            <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                <input type="radio" name="status" value="skipped" id="radio-skipped"> üî¥ –ü—Ä–æ–ø—É—â–µ–Ω–æ
            </label>
        </div>

        <button id="submit-button" class="btn-main">–ó–ë–ï–†–ï–ì–¢–ò</button>
        <button onclick="closeModal()" class="btn-cancel">–°–ö–ê–°–£–í–ê–¢–ò</button>
    </div>
</div>

<script>
    let calendar;
    const modal = document.getElementById('modal');
    const noteInput = document.getElementById('note-input');
    const submitBtn = document.getElementById('submit-button');
    let currentClickInfo = null;

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'uk',
            firstDay: 1,
            height: '100%',
            contentHeight: 'auto',
            selectable: true,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listWeek'
            },
            events: '/api/get-trainings/',

            // 1. –î–û–î–ê–í–ê–ù–ù–Ø: –ö–ª—ñ–∫ –Ω–∞ –ø—É—Å—Ç—É –∫–ª—ñ—Ç–∏–Ω–∫—É
            dateClick: function(info) {
                currentClickInfo = info;
                openModalForDate(info.dateStr);
            },

            // 2. –í–ò–î–ê–õ–ï–ù–ù–Ø: –ö–ª—ñ–∫ –Ω–∞ —ñ—Å–Ω—É—é—á—É –ø–æ–¥—ñ—é (–∫–æ–ª—å–æ—Ä–æ–≤—É —Å–º—É–∂–∫—É)
            eventClick: function(info) {
                if (confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å "${info.event.title}"?`)) {
                    deleteEvent(info.event);
                }
            },

            eventDidMount: function(info) {
                // –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è (—Ç–≤–æ—è –ª–æ–≥—ñ–∫–∞)
                if(info.event.extendedProps.status === 'done') {
                    info.el.style.backgroundColor = 'rgba(46, 204, 113, 0.8)';
                    info.el.style.borderLeft = '4px solid #2ecc71';
                } else if (info.event.extendedProps.status === 'skipped') {
                    info.el.style.backgroundColor = 'rgba(231, 76, 60, 0.8)';
                    info.el.style.borderLeft = '4px solid #e74c3c';
                } else {
                    info.el.style.backgroundColor = 'rgba(241, 196, 15, 0.8)';
                    info.el.style.borderLeft = '4px solid #f1c40f';
                    info.el.style.color = '#000';
                }
            }
        });
        calendar.render();

        submitBtn.onclick = saveTraining;
    });

    // --- –§–£–ù–ö–¶–Ü–Ø –í–ò–î–ê–õ–ï–ù–ù–Ø ---
    function deleteEvent(eventObj) {
        const entryId = eventObj.id;

        fetch(`/api/delete_calendar_entry/${entryId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                eventObj.remove(); // –í–∏–¥–∞–ª—è—î–º–æ –∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤—ñ–∑—É–∞–ª—å–Ω–æ
            } else {
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ');
            }
        })
        .catch(error => console.error('Error:', error));
    }

function openModalForDate(dateStr) {
        modal.style.display = 'flex';
        noteInput.value = '';
        noteInput.focus();

        // --- –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –î–ê–¢–ò ---
        // –†–æ–∑–±–∏–≤–∞—î–º–æ —Ä—è–¥–æ–∫ "YYYY-MM-DD" –Ω–∞ —á–∞—Å—Ç–∏–Ω–∏, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –¥–∞—Ç—É –≤ –º—ñ—Å—Ü–µ–≤–æ–º—É —á–∞—Å—ñ
        const parts = dateStr.split('-');
        // new Date(—Ä—ñ–∫, –º—ñ—Å—è—Ü—å-1, –¥–µ–Ω—å) -> –º—ñ—Å—è—Ü—ñ –≤ JS –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –∑ 0
        const clickedDate = new Date(parts[0], parts[1] - 1, parts[2]);

        const today = new Date();
        today.setHours(0,0,0,0); // –û–±–Ω—É–ª—è—î–º–æ –≥–æ–¥–∏–Ω–∏, —Ö–≤–∏–ª–∏–Ω–∏, —Å–µ–∫—É–Ω–¥–∏ –¥–ª—è "—Å—å–æ–≥–æ–¥–Ω—ñ"

        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏
        const radioPlanned = document.getElementById('radio-planned');
        const radioDone = document.getElementById('radio-done');
        const radioSkipped = document.getElementById('radio-skipped');
        const labelDone = radioDone.parentElement;
        const labelSkipped = radioSkipped.parentElement;

        // –ü–û–†–Ü–í–ù–Ø–ù–ù–Ø
        if (clickedDate > today) {
            // --- –¢–Ü–õ–¨–ö–ò –ú–ê–ô–ë–£–¢–ù–Ñ (–ó–∞–≤—Ç—Ä–∞ —ñ –¥–∞–ª—ñ) ---

            radioPlanned.checked = true;

            // –ë–ª–æ–∫—É—î–º–æ
            radioDone.disabled = true;
            radioSkipped.disabled = true;

            // –°—Ç–∏–ª—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ
            labelDone.style.opacity = '0.5';
            labelSkipped.style.opacity = '0.5';
            labelDone.style.cursor = 'not-allowed';
            labelSkipped.style.cursor = 'not-allowed';

        } else {
            // --- –°–¨–û–ì–û–î–ù–Ü –ê–ë–û –ú–ò–ù–£–õ–ï ---

            // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —Å—Ç–∞–≤–∏–º–æ "–í–∏–∫–æ–Ω–∞–Ω–æ", —è–∫—â–æ —Ü–µ –º–∏–Ω—É–ª–µ/—Å—å–æ–≥–æ–¥–Ω—ñ
            // –ê–ª–µ —è–∫—â–æ —Ö–æ—á–µ—à, —â–æ–± –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –±—É–ª–æ "–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ" –¥–ª—è —Å—å–æ–≥–æ–¥–Ω—ñ, –∑–º—ñ–Ω–∏ —Ç—É—Ç –ª–æ–≥—ñ–∫—É.
            // –ó–∞—Ä–∞–∑ —Å—Ç–æ—ó—Ç—å: –¥–ª—è —Å—å–æ–≥–æ–¥–Ω—ñ —ñ –º–∏–Ω—É–ª–æ–≥–æ -> –í–∏–∫–æ–Ω–∞–Ω–æ.
            radioDone.checked = true;

            // –†–æ–∑–±–ª–æ–∫—É—î–º–æ
            radioDone.disabled = false;
            radioSkipped.disabled = false;

            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Å—Ç–∏–ª—ñ
            labelDone.style.opacity = '1';
            labelSkipped.style.opacity = '1';
            labelDone.style.cursor = 'pointer';
            labelSkipped.style.cursor = 'pointer';
        }
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    // --- –õ–û–ì–Ü–ö–ê –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø (–¢—Ä–æ—Ö–∏ –ø–æ–∫—Ä–∞—â–µ–Ω–∞) ---
    function saveTraining() {
        if (!currentClickInfo) return;
        const title = noteInput.value;
        const statusElement = document.querySelector('input[name="status"]:checked');
        const status = statusElement ? statusElement.value : 'planned';
        const date = currentClickInfo.dateStr;

        if (title) {
            fetch('/api/add_calendar_entry/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ date: date, note: title, status: status })
            })
            .then(response => {
                if (!response.ok) throw new Error('Error');
                return response.json();
            })
            .then(data => {
                calendar.addEvent({
                    id: data.id,
                    title: title,
                    start: date,
                    allDay: true,
                    extendedProps: { status: status }
                });
                closeModal();
            })
            .catch(error => alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è'));
        } else {
            alert("–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É!");
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}